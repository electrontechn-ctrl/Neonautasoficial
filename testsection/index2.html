<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Subir imagen a Cloudinary ‚Äì HTML + JS</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 2rem; }
    .card { max-width: 720px; border: 1px solid #ddd; border-radius: 14px; padding: 1.25rem; box-shadow: 0 1px 16px rgba(0,0,0,.04); }
    .row { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    .btn { appearance: none; border: 1px solid #aaa; background: #fff; padding: .6rem 1rem; border-radius: 10px; cursor: pointer; }
    .btn[disabled] { opacity: .55; cursor: not-allowed; }
    .hint { color: #555; font-size: .95rem; margin-top: .25rem; }
    #preview { max-width: 280px; max-height: 220px; border-radius: 12px; display: none; border: 1px solid #eee; }
    #progress { width: min(420px, 100%); height: 10px; }
    #result { display: none; }
    input[type="text"] { width: 100%; padding: .55rem .7rem; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; }
    code { background: #fafafa; border: 1px solid #eee; border-radius: 6px; padding: .1rem .35rem; }
    hr { border: none; border-top: 1px dashed #ddd; margin: 1.25rem 0; }
  </style>
</head>
<body>
  <h1>Subir imagen a Cloudinary (HTML + JS)</h1>
  <p class="hint">Reemplaza <code>CLOUD_NAME</code> y <code>UPLOAD_PRESET</code> con tus valores. Este ejemplo usa <strong>uploads no firmados</strong> (unsigned) con preset p√∫blico.</p>

  <div class="card" id="native-card">
    <h2>Opci√≥n A ‚Äî Nativa con <code>XMLHttpRequest</code> (barra de progreso)</h2>

    <div class="row">
      <input id="fileInput" type="file" accept="image/*" />
      <button class="btn" id="uploadBtn" disabled>Subir a Cloudinary</button>
      <span id="sizeInfo" class="hint"></span>
    </div>

    <div class="row" style="margin-top:.75rem">
      <img id="preview" alt="Vista previa" />
    </div>

    <div style="margin:.75rem 0">
      <progress id="progress" value="0" max="100" hidden></progress>
      <div id="status" class="hint"></div>
    </div>

    <div id="result">
      <label class="hint">URL segura subida:</label>
      <input type="text" id="url" readonly />
      <div style="margin-top:.5rem" class="row">
        <button class="btn" id="copyBtn">Copiar URL</button>
        <a class="btn" id="openBtn" href="#" target="_blank" rel="noopener">Abrir en pesta√±a nueva</a>
      </div>
    </div>
  </div>

  <hr/>

  <div class="card" id="widget-card">
    <h2>Opci√≥n B ‚Äî Upload Widget oficial (2 clics)</h2>
    <p class="hint">M√°s simple, maneja m√∫ltiples fuentes (local, c√°mara, URL) y UI lista.</p>
    <button class="btn" id="openWidget">Abrir Cloudinary Upload Widget</button>
  </div>

  <!-- Script del Upload Widget de Cloudinary -->
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

  <script>
    // üîß CONFIGURA TUS CREDENCIALES (reemplaza estos valores)
    const CLOUD_NAME = "tu_cloud_name";        // p.ej. "demo"
    const UPLOAD_PRESET = "tu_upload_preset";  // preset UNSIGNED creado en Cloudinary

    // --- Utilidades UI ---
    const $ = (sel) => document.querySelector(sel);
    const fileInput = $("#fileInput");
    const uploadBtn = $("#uploadBtn");
    const progressEl = $("#progress");
    const statusEl = $("#status");
    const previewImg = $("#preview");
    const urlInput = $("#url");
    const resultBox = $("#result");
    const copyBtn = $("#copyBtn");
    const openBtn = $("#openBtn");
    const sizeInfo = $("#sizeInfo");

    // Validaciones b√°sicas
    const MAX_BYTES = 8 * 1024 * 1024; // 8 MB (ajusta a tu gusto)
    const ALLOWED_TYPES = ["image/jpeg", "image/png", "image/webp", "image/gif"]; // a√±ade m√°s si quieres

    fileInput.addEventListener("change", () => {
      const file = fileInput.files?.[0];
      resetUI();

      if (!file) {
        uploadBtn.disabled = true;
        return;
      }
      sizeInfo.textContent = `${(file.size/1024/1024).toFixed(2)} MB`;

      if (!ALLOWED_TYPES.includes(file.type)) {
        setStatus(`Tipo no permitido: ${file.type}`, true);
        uploadBtn.disabled = true;
        return;
      }
      if (file.size > MAX_BYTES) {
        setStatus(`El archivo supera el l√≠mite de ${(MAX_BYTES/1024/1024).toFixed(0)} MB.`, true);
        uploadBtn.disabled = true;
        return;
      }

      // Vista previa
      const reader = new FileReader();
      reader.onload = e => {
        previewImg.src = e.target?.result;
        previewImg.style.display = "block";
      };
      reader.readAsDataURL(file);

      uploadBtn.disabled = false;
    });

    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files?.[0];
      if (!file) return;
      try {
        const url = await uploadToCloudinary(file, { folder: "ejemplos" }); // opcional: cambia carpeta
        urlInput.value = url;
        openBtn.href = url;
        resultBox.style.display = "block";
        setStatus("¬°Listo! Imagen subida correctamente.");
      } catch (err) {
        setStatus(err.message || String(err), true);
      }
    });

    copyBtn.addEventListener("click", async () => {
      if (!urlInput.value) return;
      try {
        await navigator.clipboard.writeText(urlInput.value);
        setStatus("URL copiada al portapapeles.");
      } catch {
        setStatus("No se pudo copiar. Selecciona y copia manualmente.", true);
      }
    });

    function resetUI() {
      progressEl.hidden = true;
      progressEl.value = 0;
      statusEl.textContent = "";
      resultBox.style.display = "none";
      previewImg.style.display = "none";
    }
    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? "#b00020" : "#333";
    }

    // --- SUBIDA NATIVA A CLOUDINARY (unsigned) ---
    function uploadToCloudinary(file, opts = {}) {
      return new Promise((resolve, reject) => {
        const endpoint = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET); // preset UNSIGNED
        if (opts.folder) formData.append("folder", opts.folder);
        if (opts.tags) formData.append("tags", [].concat(opts.tags).join(","));
        if (opts.public_id) formData.append("public_id", opts.public_id);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", endpoint);

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressEl.hidden = false;
            progressEl.value = percent;
            setStatus(`Subiendo‚Ä¶ ${percent}%`);
          }
        };

        xhr.onerror = () => {
          reject(new Error("Error de red durante la subida."));
        };

        xhr.onload = () => {
          try {
            const res = JSON.parse(xhr.responseText || "{}");
            if (xhr.status >= 200 && xhr.status < 300) {
              resolve(res.secure_url);
            } else {
              reject(new Error(res.error?.message || `Error ${xhr.status}`));
            }
          } catch {
            reject(new Error("Respuesta inv√°lida del servidor."));
          }
        };

        xhr.send(formData);
      });
    }

    // --- CLOUDINARY UPLOAD WIDGET (opci√≥n B) ---
    const openWidgetBtn = $("#openWidget");
    const widget = cloudinary.createUploadWidget(
      {
        cloudName: CLOUD_NAME,
        uploadPreset: UPLOAD_PRESET,
        sources: ["local", "url", "camera"],
        multiple: false,
        folder: "ejemplos", // opcional
        maxFileSize: MAX_BYTES,
      },
      (error, result) => {
        if (error) {
          setStatus(error?.message || "Error en el widget", true);
          return;
        }
        if (result && result.event === "success") {
          const url = result.info.secure_url;
          urlInput.value = url;
          openBtn.href = url;
          resultBox.style.display = "block";
          setStatus("¬°Listo! Imagen subida con el widget.");
        }
      }
    );

    openWidgetBtn.addEventListener("click", () => widget.open());

    // ‚ÑπÔ∏è NOTA IMPORTANTE
    // Para producci√≥n, considera subidas firmadas (signed uploads) generando la firma en tu backend
    // para mayor control (p.ej. restricciones, caducidad, etc.).
  </script>
</body>
</html>
