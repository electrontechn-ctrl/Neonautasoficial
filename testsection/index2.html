<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <title>Subir imagen a Cloudinary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    body {
      display: grid;
      place-items: center;
      min-height: 100dvh;
      padding: 24px;
      background: #f6f7f9;
    }

    .card {
      width: min(720px, 100%);
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, .08);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 20px;
    }

    p {
      margin: 0 0 16px;
      color: #555;
    }

    .dropzone {
      border: 2px dashed #c7cbd1;
      border-radius: 12px;
      padding: 18px;
      background: #fafbfc;
      display: grid;
      gap: 12px;
      place-items: center;
      text-align: center;
      color: #667085;
      transition: background .2s, border-color .2s;
    }

    .dropzone.dragover {
      background: #eef6ff;
      border-color: #5b9cff;
      color: #1f5fbf;
    }

    input[type="file"] {
      display: none;
    }

    .actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      background: #1a73e8;
      color: #fff;
      border: 0;
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn.secondary {
      background: #e9eef6;
      color: #1f2937;
    }

    .preview {
      margin-top: 12px;
      display: grid;
      place-items: center;
    }

    .preview img {
      max-width: 100%;
      max-height: 280px;
      border-radius: 12px;
      box-shadow: 0 4px 18px rgba(0, 0, 0, .08);
    }

    .progress {
      height: 8px;
      width: 100%;
      background: #edf2f7;
      border-radius: 999px;
      overflow: hidden;
      margin: 12px 0;
    }

    .bar {
      height: 100%;
      width: 0%;
      background: #1a73e8;
      transition: width .15s;
    }

    .result {
      word-break: break-all;
      padding: 10px 12px;
      background: #f8fafc;
      border-radius: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Subir imagen a Cloudinary</h1>
    <p>Arrastra una imagen o haz clic para elegir un archivo. Luego presiona ‚ÄúSubir‚Äù.</p>

    <label class="dropzone" id="dropzone">
      <input id="fileInput" type="file" accept="image/*" />
      <div>
        <div style="font-weight:600;">Arrastra y suelta tu imagen aqu√≠</div>
        <div class="hint">o haz clic para seleccionar</div>
      </div>
    </label>

    <div class="preview" id="preview" hidden>
      <img id="previewImg" alt="Vista previa" />
      <div class="hint" id="fileInfo"></div>
    </div>

    <div class="progress" title="Progreso de subida">
      <div class="bar" id="progressBar"></div>
    </div>

    <div class="actions">
      <button class="btn secondary" id="chooseBtn">Elegir archivo</button>
      <button class="btn" id="uploadBtn" disabled>Subir a Cloudinary</button>
    </div>

    <div id="status" class="hint" style="margin-top:8px;"></div>

    <div id="resultWrap" style="margin-top:12px;" hidden>
      <div class="hint" style="margin-bottom:6px;">URL del archivo subido:</div>
      <div class="result" id="resultUrl"></div>
      <div class="actions" style="margin-top:10px;">
        <a id="openLink" class="btn" target="_blank" rel="noopener">Abrir</a>
        <button id="copyBtn" class="btn secondary" type="button">Copiar URL</button>
      </div>
    </div>
  </div>

  <script>
    // üîß Configura tus credenciales:
    const CLOUD_NAME = "danqyk0wz";     // <- el del dashboard, con Q
    const UPLOAD_PRESET = "storagehml"; // <- exactamente como sale en "Upload Presets"

    const FOLDER = ""; // opcional: p.ej. "mis-subidas"

    // ‚öôÔ∏è L√≠mite de tama√±o (opcional): 10MB
    const MAX_SIZE_BYTES = 10 * 1024 * 1024;

    // üîó Endpoint de subida unsigned
    const UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

    const fileInput = document.getElementById("fileInput");
    const dropzone = document.getElementById("dropzone");
    const chooseBtn = document.getElementById("chooseBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const preview = document.getElementById("preview");
    const previewImg = document.getElementById("previewImg");
    const fileInfo = document.getElementById("fileInfo");
    const progressBar = document.getElementById("progressBar");
    const statusEl = document.getElementById("status");
    const resultWrap = document.getElementById("resultWrap");
    const resultUrl = document.getElementById("resultUrl");
    const openLink = document.getElementById("openLink");
    const copyBtn = document.getElementById("copyBtn");

    let currentFile = null;

    // Helpers
    const fmtBytes = (bytes) => {
      const units = ["B", "KB", "MB", "GB"];
      let i = 0, num = bytes;
      while (num >= 1024 && i < units.length - 1) { num /= 1024; i++; }
      return `${num.toFixed(num >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;
    };

    function resetUI() {
      progressBar.style.width = "0%";
      statusEl.textContent = "";
      resultWrap.hidden = true;
      resultUrl.textContent = "";
      openLink.href = "#";
    }

    function setFile(file) {
      currentFile = file;
      resetUI();

      if (!file) {
        preview.hidden = true;
        uploadBtn.disabled = true;
        return;
      }

      if (!file.type.startsWith("image/")) {
        statusEl.textContent = "El archivo seleccionado no es una imagen.";
        uploadBtn.disabled = true;
        preview.hidden = true;
        return;
      }

      if (file.size > MAX_SIZE_BYTES) {
        statusEl.textContent = `El archivo supera el l√≠mite (${fmtBytes(MAX_SIZE_BYTES)}).`;
        uploadBtn.disabled = true;
        preview.hidden = true;
        return;
      }

      // Vista previa
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      preview.hidden = false;
      fileInfo.textContent = `${file.name} ‚Äî ${fmtBytes(file.size)}`;
      uploadBtn.disabled = false;
    }

    chooseBtn.addEventListener("click", () => fileInput.click());
    dropzone.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      setFile(file || null);
    });

    // Drag & drop
    ["dragenter", "dragover"].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.add("dragover");
      })
    );
    ["dragleave", "drop"].forEach(evt =>
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.remove("dragover");
      })
    );
    dropzone.addEventListener("drop", (e) => {
      const file = e.dataTransfer.files?.[0];
      setFile(file || null);
    });

    // Subir a Cloudinary (unsigned)
    uploadBtn.addEventListener("click", async () => {
      if (!currentFile) return;

      uploadBtn.disabled = true;
      statusEl.textContent = "Subiendo‚Ä¶";

      const form = new FormData();
      form.append("file", currentFile);
      form.append("upload_preset", UPLOAD_PRESET);
      if (FOLDER) form.append("folder", FOLDER);
      // Opcionales:
      // form.append("tags", "demo,ejemplo");
      // form.append("context", "caption=Mi imagen|alt=Descripci√≥n accesible");

      try {
        const response = await xhrUpload(UPLOAD_URL, form, (pct) => {
          progressBar.style.width = pct + "%";
        });

        if (!response.secure_url) {
          throw new Error("Respuesta inesperada del servidor.");
        }

        statusEl.textContent = "¬°Listo! Subida completa ‚úÖ";
        resultUrl.textContent = response.secure_url;
        resultWrap.hidden = false;
        openLink.href = response.secure_url;

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error al subir la imagen. Revisa tu cloud name y preset.";
      } finally {
        uploadBtn.disabled = false;
      }
    });

    // Subida con progreso usando XHR
    function xhrUpload(url, formData, onProgress) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", url);
        xhr.upload.addEventListener("progress", (e) => {
          if (e.lengthComputable && typeof onProgress === "function") {
            const pct = Math.round((e.loaded / e.total) * 100);
            onProgress(pct);
          }
        });
        xhr.onreadystatechange = () => {
          if (xhr.readyState === 4) {
            try {
              const json = JSON.parse(xhr.responseText || "{}");
              if (xhr.status >= 200 && xhr.status < 300) resolve(json);
              else reject(json.error || json);
            } catch (e) {
              reject(e);
            }
          }
        };
        xhr.onerror = () => reject(new Error("Fallo de red"));
        xhr.send(formData);
      });
    }

    // Copiar URL
    copyBtn.addEventListener("click", async () => {
      const url = resultUrl.textContent.trim();
      if (!url) return;
      try {
        await navigator.clipboard.writeText(url);
        copyBtn.textContent = "¬°Copiado!";
        setTimeout(() => (copyBtn.textContent = "Copiar URL"), 1200);
      } catch {
        // Fallback
        const sel = window.getSelection();
        const range = document.createRange();
        range.selectNodeContents(resultUrl);
        sel.removeAllRanges();
        sel.addRange(range);
        document.execCommand("copy");
        sel.removeAllRanges();
        copyBtn.textContent = "¬°Copiado!";
        setTimeout(() => (copyBtn.textContent = "Copiar URL"), 1200);
      }
    });
  </script>
</body>

</html>