<!doctype html>
<html lang="es">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Captura con fondo (local)</title>

<style>
  :root {
    /* Fondo predeterminado. Si existe fondofiesta.jpg, el JS lo sustituye automáticamente */
    --bg-image: linear-gradient(120deg, #111, #333);
  }

  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    margin: 0; min-height: 100vh; display: grid; place-items: center;
    background: #0c0c0c; color: #fff;
  }

  .wrap { display: grid; gap: 12px; place-items: center; }

  /* Área a capturar */
  #design {
    position: relative; width: 360px; height: 560px;
    border-radius: 16px; overflow: hidden; box-shadow: 0 12px 30px rgba(0,0,0,.35);
    isolation: isolate;
  }
  #design::before {
    content: ""; position: absolute; inset: 0; z-index: 0;
    background: var(--bg-image) center / cover no-repeat; /* pon "contain" si no quieres recorte */
  }
  .overlay { position: absolute; inset: 0; z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.45)); pointer-events: none; }
  .content { position: relative; z-index: 2; padding: 24px; text-align: center; display: grid; gap: 8px; }
  h1 { margin: 0 0 4px; font-size: 18px; }
  p { margin: 0; }

  button, label[for="bgfile"] {
    padding: 10px 14px; border-radius: 10px; border: 1px solid #444; background: #1c1c1c; color: #fff; cursor: pointer;
  }
  #preview { max-width: 360px; display: none; border-radius: 12px; }
  small { color: #b7b7b7; }
  input[type="file"] { display: none; }
</style>

<div class="wrap">
  <div id="design">
    <div class="overlay"></div>
    <div class="content">
      <h1>Mi diseño</h1>
      <p>Texto, logos, etc.</p>
    </div>
  </div>

  <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center;">
    <label for="bgfile">Elegir imagen de fondo…</label>
    <button id="btn-png">Guardar como PNG</button>
    <button id="btn-jpg">Guardar como JPG</button>
  </div>

  <small>Todo se guarda <b>localmente</b>. Nada se sube.</small>
  <img id="preview" alt="Previsualización" />
</div>

<!-- Input de archivo real (el label funciona como botón) -->
<input id="bgfile" type="file" accept="image/*">

<!-- DOM → imagen -->
<script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = (sel) => document.querySelector(sel);
  const design = $('#design');
  const bgInput = $('#bgfile');
  const preview = $('#preview');

  // 1) Si existe ./fondofiesta.jpg en la misma carpeta, úsala como fondo por defecto
  (async () => {
    try {
      const r = await fetch('../sources/img/fondofiesta.jpg', { method: 'HEAD' });
      if (r.ok) document.documentElement.style.setProperty('--bg-image', 'url("../sources/img/fondofiesta.jpg")');
      // Si no existe, no pasa nada: se queda el degradado y NO hay error en consola.
    } catch(_) {}
  })();

  // 2) Selector de fondo local (convierte a dataURL -> sin CORS)
  if (bgInput) {
    bgInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        document.documentElement.style.setProperty('--bg-image', `url('${reader.result}')`);
      };
      reader.readAsDataURL(f);
    });
  } else {
    console.warn('No se encontró #bgfile en el DOM');
  }

  // Utilidades
  const pad = n => String(n).padStart(2,'0');
  const ts = () => { const d = new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`;
  };

  async function captureToDataUrl(type = 'png', quality = 0.92) {
    try { if (document.fonts?.ready) await document.fonts.ready; } catch(e) {}
    const pixelRatio = Math.max(2, window.devicePixelRatio || 1);
    const opts = { pixelRatio, cacheBust: true, useCors: true, backgroundColor: null };
    return (type === 'jpeg' || type === 'jpg')
      ? await htmlToImage.toJpeg(design, { ...opts, quality })
      : await htmlToImage.toPng(design, opts);
  }

  async function dataUrlToBlob(dataUrl) {
    const res = await fetch(dataUrl); return await res.blob();
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href: url, download: filename });
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  async function captureAndSave(kind) {
    try {
      const isJpg = kind === 'jpg' || kind === 'jpeg';
      const dataUrl = await captureToDataUrl(isJpg ? 'jpeg' : 'png', 0.92);
      const blob = await dataUrlToBlob(dataUrl);
      preview.src = dataUrl; preview.style.display = 'block';
      downloadBlob(blob, `diseno-${ts()}.${isJpg ? 'jpg' : 'png'}`);
    } catch (e) {
      console.error('Error al capturar/guardar:', e);
      alert('No se pudo capturar o guardar. Revisa la consola.');
    }
  }

  $('#btn-png').addEventListener('click', () => captureAndSave('png'));
  $('#btn-jpg').addEventListener('click', () => captureAndSave('jpg'));
});
</script>
</html>
